<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Inventario y Gastos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-button.active { border-bottom-color: #3b82f6; color: #1e40af; font-weight: 600; }
        .product-line .remove-product-btn, .label-product-entry .remove-label-product-btn { display: none; }
        .product-line:not(:first-child) .remove-product-btn, .label-product-entry:not(:first-child) .remove-label-product-btn { display: inline-flex; }
        .stock-display { transition: opacity 0.3s; }

        /* --- Estilos para la Pesta√±a de Etiquetas --- */
        #labels-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 1cm;
            width: 100%;
            max-width: 21cm;
            min-height: 29.7cm;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin: 2rem auto;
            border-radius: 8px;
        }
        .label {
            border: 1px dashed #9ca3af;
            padding: 12px;
            border-radius: 8px;
            overflow-wrap: break-word;
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.75rem;
            line-height: 1.4;
        }
        .label p, .label div { margin: 0; }
        .label strong { font-weight: 600; color: #1f2937; }

        @media print {
            @page {
                size: auto;
                margin: 0.5cm;
            }
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                background-color: #ffffff !important;
            }
            #main-form-container, .non-printable {
                display: none !important;
            }
            #print-area, #labels-container {
                margin: 0; padding: 0; width: 100%; min-height: 0;
                box-shadow: none; border: none; border-radius: 0;
                background-color: transparent !important;
            }
            .label {
                page-break-inside: avoid;
                border: 1px solid #6b7280;
            }
        }

        @media (max-width: 768px) {
            #labels-container {
                min-height: auto; padding: 1rem;
            }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen p-4">
    
    <div id="main-form-container" class="bg-white shadow-2xl rounded-xl p-6 md:p-10 w-full max-w-4xl mx-auto">
        <header class="mb-6 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-700">üçØ Control de Negocio</h1>
        </header>

        <div class="border-b border-slate-200 mb-6">
            <nav class="flex flex-wrap -mb-px space-x-4">
                <button id="tabInventoryBtn" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Movimientos de Inventario</button>
                <button id="tabExpenseBtn" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700">Registro de Gastos</button>
                <button id="tabLabelsBtn" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700">Generar Etiquetas</button>
            </nav>
        </div>

        <!-- PESTA√ëA DE INVENTARIO -->
        <div id="inventoryContent">
            <form id="inventoryForm">
                <input type="hidden" name="formType" value="inventory">
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Tipo de Movimiento:</label>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center"><input type="radio" name="tipoMovimiento" value="Ingreso" required checked class="h-4 w-4 text-sky-600 border-slate-300 focus:ring-sky-500"><span class="ml-2 text-slate-700">Ingreso</span></label>
                            <label class="flex items-center"><input type="radio" name="tipoMovimiento" value="Venta" required class="h-4 w-4 text-sky-600 border-slate-300 focus:ring-sky-500"><span class="ml-2 text-slate-700">Venta</span></label>
                        </div>
                    </div>
                    <div id="formIngreso" class="space-y-4">
                        <div>
                            <label for="productoIngreso" class="block text-sm font-medium text-slate-700 mb-1">Producto:</label>
                            <div>
                                <select id="productoIngreso" name="producto" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500"></select>
                                <div id="stockIngreso" class="text-right text-sm text-slate-500 font-semibold h-5 mt-1 pr-1"></div>
                            </div>
                        </div>
                        <div>
                            <label for="cantidadIngreso" class="block text-sm font-medium text-slate-700 mb-1">Cantidad:</label>
                            <input type="number" id="cantidadIngreso" name="cantidad" min="1" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500" placeholder="Ej: 10">
                        </div>
                    </div>
                    <div id="formVenta" class="hidden space-y-6">
                         <!-- Fila 1: Factura y Muestra -->
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                            <div>
                               <label for="numeroFactura" class="block text-sm font-medium text-slate-700 mb-1">N√∫mero de Factura:</label>
                               <input type="text" id="numeroFactura" name="numeroFactura" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500" placeholder="Ej: 001-001-0001234">
                           </div>
                           <div class="flex items-center pt-6">
                               <input type="checkbox" id="esMuestra" name="esMuestra" class="h-5 w-5 text-sky-600 border-slate-300 rounded focus:ring-sky-500">
                               <label for="esMuestra" class="ml-2 block text-sm font-medium text-slate-700">Registrar como Muestra (sin venta)</label>
                           </div>
                        </div>

                        <!-- Fila 2: Configuraci√≥n POS -->
                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <div class="flex items-center mb-2">
                                <input type="checkbox" id="pagoConPOS" name="pagoConPOS" class="h-5 w-5 text-sky-600 border-slate-300 rounded focus:ring-sky-500">
                                <label for="pagoConPOS" class="ml-2 block text-sm font-medium text-slate-700">Venta con POS (Comisi√≥n)</label>
                            </div>
                            <div id="posFields" class="hidden ml-7 mt-2">
                                <label for="comisionPOS" class="block text-sm font-medium text-slate-700 mb-1">% Comisi√≥n POS:</label>
                                <div class="relative w-32">
                                    <input type="number" id="comisionPOS" name="comisionPOS" step="0.01" min="0" max="100" class="w-full p-2 pr-8 border border-slate-300 rounded-md shadow-sm focus:ring-2 focus:ring-sky-500 text-sm" placeholder="Ej: 3">
                                    <span class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 text-sm">%</span>
                                </div>
                                <p class="text-xs text-slate-500 mt-1">Este porcentaje se restar√° del total registrado.</p>
                            </div>
                        </div>

                        <div id="productLines" class="space-y-4 border-t border-b border-slate-200 py-4"></div>
                        <div class="flex justify-between items-center">
                            <button type="button" id="addProductBtn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-lg shadow-sm">+ A√±adir Producto</button>
                            <div class="text-right">
                                <p class="text-slate-600">Total de la Venta:</p>
                                <p id="saleTotal" class="text-2xl font-bold text-slate-800">$0.00</p>
                            </div>
                        </div>
                        <div>
                            <label for="descripcionVenta" class="block text-sm font-medium text-slate-700 mb-1">Descripci√≥n:</label>
                            <textarea id="descripcionVenta" name="descripcionVenta" rows="2" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500" placeholder="Ej: Venta a cliente minorista"></textarea>
                        </div>
                    </div>
                </div>
                <div class="flex items-center justify-end pt-6"><button type="submit" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2">Registrar Movimiento</button></div>
            </form>
        </div>
        
        <!-- PESTA√ëA DE GASTOS -->
        <div id="expenseContent" class="hidden">
             <form id="expenseForm" class="space-y-6">
                <input type="hidden" name="formType" value="expense">
                <div>
                    <label for="tipoGasto" class="block text-sm font-medium text-slate-700 mb-1">Tipo de Gasto:</label>
                    <select id="tipoGasto" name="tipoGasto" required class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                        <option value="" disabled selected>Selecciona un tipo...</option>
                        <option value="Transporte">Transporte</option>
                        <option value="Material de Empaque">Material de Empaque</option>
                        <option value="Insumos">Insumos</option>
                        <option value="Publicidad">Publicidad</option>
                        <option value="Servicios (Luz, Agua, etc.)">Servicios (Luz, Agua, etc.)</option>
                        <option value="Salarios">Salarios</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                <div class="grid grid-cols-3 gap-4 items-end">
                     <div class="col-span-2">
                        <label for="valorGasto" class="block text-sm font-medium text-slate-700 mb-1">Valor del Gasto:</label>
                        <input type="number" id="valorGasto" name="valorGasto" required step="0.01" min="0" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500" placeholder="Ej: 50.75">
                    </div>
                     <div class="col-span-1 flex items-center pb-3">
                        <input type="checkbox" id="gastoIncluyeIVA" name="gastoIncluyeIVA" checked class="h-4 w-4 text-sky-600 border-slate-300 rounded focus:ring-sky-500">
                        <label for="gastoIncluyeIVA" class="ml-2 text-sm text-slate-700">Incluye IVA</label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">M√©todo de Pago:</label>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center"><input type="radio" name="metodoPago" value="Efectivo" required checked class="h-4 w-4 text-sky-600 border-slate-300 focus:ring-sky-500"><span class="ml-2 text-slate-700">Efectivo</span></label>
                        <label class="flex items-center"><input type="radio" name="metodoPago" value="Tarjeta" required class="h-4 w-4 text-sky-600 border-slate-300 focus:ring-sky-500"><span class="ml-2 text-slate-700">Tarjeta</span></label>
                    </div>
                </div>
                <div>
                    <label for="descripcionGasto" class="block text-sm font-medium text-slate-700 mb-1">Descripci√≥n del Gasto:</label>
                    <textarea id="descripcionGasto" name="descripcionGasto" required rows="3" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500" placeholder="Ej: Compra de cajas para env√≠o"></textarea>
                </div>
                <div class="flex items-center justify-end pt-4"><button type="submit" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md">Registrar Gasto</button></div>
            </form>
        </div>

        <!-- PESTA√ëA DE ETIQUETAS -->
        <div id="labelsContent" class="hidden">
            <!-- ... (Contenido de etiquetas se mantiene igual) ... -->
             <p class="text-slate-600 mb-6">Completa los campos para crear una nueva etiqueta y agr√©gala a la hoja de impresi√≥n.</p>
            <form id="label-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div>
                    <label for="labelName" class="block text-sm font-medium text-slate-700 mb-1">Nombre y Apellido</label>
                    <input type="text" id="labelName" required class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500">
                </div>
                <div>
                    <label for="labelPhone" class="block text-sm font-medium text-slate-700 mb-1">Tel√©fono</label>
                    <input type="tel" id="labelPhone" required class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500">
                </div>
                <div class="md:col-span-2">
                    <label for="labelAddress" class="block text-sm font-medium text-slate-700 mb-1">Direcci√≥n de Entrega</label>
                    <textarea id="labelAddress" rows="3" required class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500"></textarea>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Productos a Entregar</label>
                    <div id="label-products-list" class="space-y-3"></div>
                    <button type="button" id="add-label-product-btn" class="mt-3 text-sm text-sky-600 hover:text-sky-800 font-semibold">+ A√±adir otro producto</button>
                </div>
                <div>
                    <label for="labelPrice" class="block text-sm font-medium text-slate-700 mb-1">Precio (Total)</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-500">$</span>
                        <input type="number" id="labelPrice" step="0.01" required class="w-full pl-7 pr-3 py-2 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500">
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label for="label-payment-method" class="block text-sm font-medium text-slate-700 mb-1">M√©todo de Pago</label>
                    <select id="label-payment-method" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500">
                        <option>Efectivo</option>
                        <option>Transferencia</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                     <button type="submit" class="w-full mt-4 bg-sky-600 text-white font-semibold py-3 px-4 rounded-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
                        Agregar Etiqueta a la Cola
                    </button>
                </div>
            </form>
        </div>

        <div class="flex items-center justify-end space-x-3 mt-6">
            <div id="loader" class="loader"></div>
            <div id="message" class="flex-grow p-4 rounded-lg text-center text-sm" role="alert"></div>
        </div>
    </div>
    
    <!-- Contenedor para la impresi√≥n de etiquetas -->
    <div class="non-printable max-w-3xl mx-auto mt-8">
        <div id="action-buttons" class="hidden flex-col sm:flex-row gap-4 mb-8">
            <button id="print-btn" class="w-full sm:w-auto flex-1 bg-green-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-green-700">
                Imprimir Todas las Etiquetas
            </button>
            <button id="clear-btn" class="w-full sm:w-auto flex-1 bg-red-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-red-700">
                Limpiar Cola de Impresi√≥n
            </button>
        </div>
    </div>
    <div id="print-area">
        <div id="labels-container"></div>
    </div>

    <template id="productOptionsTemplate">
        <option value="" disabled selected>Selecciona un producto...</option>
        <option value="Miel Picante Baja botella 350 g">Miel Picante Baja botella 350 g</option>
        <option value="Miel Picante Media botella 350 g">Miel Picante Media botella 350 g</option>
        <option value="Miel Picante Alta botella 350 g">Miel Picante Alta botella 350 g</option>
        <option value="Miel Picante Baja sachet">Miel Picante Baja sachet</option>
        <option value="Miel Picante Media sachet">Miel Picante Media sachet</option>
        <option value="Miel Picante Alta sachet">Miel Picante Alta sachet</option>
        <option value="Miel Picante Baja gal√≥n">Miel Picante Baja gal√≥n</option>
        <option value="Miel Picante Media gal√≥n">Miel Picante Media gal√≥n</option>
        <option value="Miel Picante Alta gal√≥n">Miel Picante Alta gal√≥n</option>
    </template>

    <script>
        const FULL_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxMapJvU3t9B7c0sfZIQRJbjPZpqjVVQCF9gsJrQd4evSVDCeNnPKlRfdkPLoxkZE8JyA/exec';
        
        // --- REFERENCIAS ---
        const tabInventoryBtn = document.getElementById('tabInventoryBtn');
        const tabExpenseBtn = document.getElementById('tabExpenseBtn');
        const tabLabelsBtn = document.getElementById('tabLabelsBtn');
        const inventoryContent = document.getElementById('inventoryContent');
        const expenseContent = document.getElementById('expenseContent');
        const labelsContent = document.getElementById('labelsContent');
        
        const inventoryForm = document.getElementById('inventoryForm');
        const expenseForm = document.getElementById('expenseForm');
        const labelForm = document.getElementById('label-form');
        
        const productOptionsTemplate = document.getElementById('productOptionsTemplate');
        const messageDiv = document.getElementById('message');
        const loader = document.getElementById('loader');

        // Inventario
        const movementRadios = document.querySelectorAll('input[name="tipoMovimiento"]');
        const formIngreso = document.getElementById('formIngreso');
        const formVenta = document.getElementById('formVenta');
        const productLinesContainer = document.getElementById('productLines');
        const addProductBtn = document.getElementById('addProductBtn');
        const saleTotalEl = document.getElementById('saleTotal');
        const pagoConPOSCheckbox = document.getElementById('pagoConPOS');
        const posFields = document.getElementById('posFields');
        
        // Etiquetas
        const labelsContainer = document.getElementById('labels-container');
        const printBtn = document.getElementById('print-btn');
        const clearBtn = document.getElementById('clear-btn');
        const addLabelProductBtn = document.getElementById('add-label-product-btn');
        const labelProductsList = document.getElementById('label-products-list');
        const actionButtons = document.getElementById('action-buttons');

        // --- FUNCIONES ---

        function switchTab(activeTab) {
            messageDiv.textContent = ''; messageDiv.className = 'flex-grow p-4 rounded-lg text-center text-sm';
            const tabs = { inventory: tabInventoryBtn, expense: tabExpenseBtn, labels: tabLabelsBtn };
            const contents = { inventory: inventoryContent, expense: expenseContent, labels: labelsContent };

            for (const key in tabs) {
                const isActive = key === activeTab;
                tabs[key].classList.toggle('active', isActive);
                tabs[key].classList.toggle('text-slate-500', !isActive);
                contents[key].classList.toggle('hidden', !isActive);
            }
            actionButtons.classList.toggle('hidden', activeTab !== 'labels');
        }

        function toggleInventoryForms() {
            const selectedValue = document.querySelector('input[name="tipoMovimiento"]:checked').value;
            formVenta.classList.toggle('hidden', selectedValue !== 'Venta');
            formIngreso.classList.toggle('hidden', selectedValue === 'Venta');
            if (selectedValue === 'Venta' && productLinesContainer.children.length === 0) {
                addProductLine();
            }
        }
        
        // Toggle POS fields
        pagoConPOSCheckbox.addEventListener('change', () => {
            posFields.classList.toggle('hidden', !pagoConPOSCheckbox.checked);
            // Si se oculta, limpiar el valor? Opcional.
        });

        function addProductLine() {
            const lineDiv = document.createElement('div');
            lineDiv.className = 'product-line grid grid-cols-12 gap-x-2 gap-y-3 items-start border-t pt-3';
            lineDiv.innerHTML = `
                <div class="col-span-12 sm:col-span-4">
                    <select name="producto" class="w-full p-2 border border-slate-300 rounded-md shadow-sm">${productOptionsTemplate.innerHTML}</select>
                    <div class="stock-display text-right text-sm text-slate-500 font-semibold h-5 mt-1 pr-1"></div>
                </div>
                <div class="col-span-4 sm:col-span-2"><input type="number" name="cantidad" min="1" placeholder="Cant." class="w-full p-2 border border-slate-300 rounded-md shadow-sm"></div>
                <div class="col-span-8 sm:col-span-2"><input type="number" name="precioUnitario" step="0.01" min="0" placeholder="P. Unit." class="w-full p-2 border border-slate-300 rounded-md shadow-sm"></div>
                <div class="col-span-8 sm:col-span-3"><input type="text" name="subtotal" readonly class="w-full p-2 bg-slate-100 border-slate-300 rounded-md text-right font-medium" value="$0.00"></div>
                <div class="col-span-4 sm:col-span-1 flex items-center justify-end space-x-2">
                    <input type="checkbox" name="incluyeIVA" checked class="h-4 w-4 text-sky-600 border-slate-300 rounded focus:ring-sky-500">
                    <label class="text-xs text-slate-500">IVA</label>
                    <button type="button" class="remove-product-btn text-red-500 hover:text-red-700 font-bold p-1 rounded-full leading-none flex items-center justify-center h-6 w-6">‚úï</button>
                </div>`;
            productLinesContainer.appendChild(lineDiv);
        }

        function updateLineAndTotal(lineElement) {
            const qty = parseFloat(lineElement.querySelector('input[name="cantidad"]').value) || 0;
            const unitPrice = parseFloat(lineElement.querySelector('input[name="precioUnitario"]').value) || 0;
            const subtotal = qty * unitPrice;
            lineElement.querySelector('input[name="subtotal"]').value = `$${subtotal.toFixed(2)}`;
            updateSaleTotal();
        }

        function updateSaleTotal() {
            const lines = document.querySelectorAll('.product-line');
            let total = 0;
            lines.forEach(line => {
                const qty = parseFloat(line.querySelector('input[name="cantidad"]').value) || 0;
                const unitPrice = parseFloat(line.querySelector('input[name="precioUnitario"]').value) || 0;
                total += qty * unitPrice;
            });
            saleTotalEl.textContent = `$${total.toFixed(2)}`;
        }
        
        // ... [L√≥gica de Etiquetas y fetchStock igual que antes] ...
         async function fetchStock(productName, displayElement) {
            if (!productName) {
                displayElement.textContent = '';
                return;
            }
            displayElement.textContent = '...';
            try {
                const response = await fetch(`${FULL_SCRIPT_URL}?action=getStock&producto=${encodeURIComponent(productName)}`);
                if (!response.ok) throw new Error('Err');
                const result = await response.json();
                displayElement.textContent = result.success ? `Stock: ${result.stock}` : 'Stock: 0';
            } catch (error) {
                displayElement.textContent = 'Err Stock';
            }
        }
        
        document.getElementById('productoIngreso').addEventListener('change', (e) => {
            fetchStock(e.target.value, document.getElementById('stockIngreso'));
        });
        productLinesContainer.addEventListener('change', (e) => {
            if (e.target.name === 'producto') {
                fetchStock(e.target.value, e.target.parentElement.querySelector('.stock-display'));
            }
        });
        
        // ... [L√≥gica de submit] ...
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (e.target.id === 'label-form') return; 

            loader.style.display = 'block';
            messageDiv.textContent = ''; messageDiv.className = 'flex-grow p-4 rounded-lg text-center text-sm';
            
            const formElement = e.target;
            const formData = new FormData(formElement);
            let data = { formType: formElement.id.replace('Form', '') };
            
            if(data.formType === 'inventory') {
                 data.tipoMovimiento = formData.get('tipoMovimiento');
                 if (data.tipoMovimiento === 'Venta') {
                    const productLines = document.querySelectorAll('#productLines .product-line');
                    const productos = Array.from(productLines).map(line => ({
                        producto: line.querySelector('select[name="producto"]').value,
                        cantidad: line.querySelector('input[name="cantidad"]').value,
                        precioUnitario: line.querySelector('input[name="precioUnitario"]').value,
                        incluyeIVA: line.querySelector('input[name="incluyeIVA"]').checked,
                    }));

                    if (productos.some(p => !p.producto || !p.cantidad || !p.precioUnitario)) {
                        showMessage('Por favor, complete todos los campos de producto.', 'error');
                        loader.style.display = 'none';
                        return;
                    }

                    data.esMuestra = formData.get('esMuestra') === 'on';
                    data.pagoConPOS = formData.get('pagoConPOS') === 'on';
                    data.comisionPOS = formData.get('comisionPOS');
                    data.numeroFactura = formData.get('numeroFactura');
                    data.descripcionVenta = formData.get('descripcionVenta');
                    data.productos = productos;
                 } else { 
                     data.producto = formData.get('producto');
                     data.cantidad = formData.get('cantidad');
                 }
            } else if (data.formType === 'expense') {
                 data.tipoGasto = formData.get('tipoGasto');
                 data.valorGasto = formData.get('valorGasto');
                 data.gastoIncluyeIVA = formData.get('gastoIncluyeIVA') === 'on';
                 data.metodoPago = formData.get('metodoPago');
                 data.descripcionGasto = formData.get('descripcionGasto');
            }

            try {
                const response = await fetch(FULL_SCRIPT_URL, {
                    method: 'POST', mode: 'cors', body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    showMessage(result.message || '¬°Operaci√≥n registrada!', 'success');
                    formElement.reset();
                    if(formElement.id === 'inventoryForm' && data.tipoMovimiento === 'Venta') {
                         productLinesContainer.innerHTML = '';
                         addProductLine();
                         updateSaleTotal();
                         posFields.classList.add('hidden'); // Ocultar campos POS al resetear
                    }
                    toggleInventoryForms();
                    document.getElementById('stockIngreso').textContent = '';
                } else {
                     let errorMessage = result.error || 'Error desconocido.';
                     if (result.error === 'STOCK_INSUFICIENTE') {
                         errorMessage = `Error: Stock insuficiente para '${result.producto}'. Stock actual: ${result.currentStock}.`;
                     }
                    showMessage(errorMessage, 'error');
                }
            } catch (error) {
                showMessage(`Error de conexi√≥n: ${error.message}`, 'error');
            } finally {
                loader.style.display = 'none';
            }
        }
        
        // ... [Funciones de Etiquetas] ...
        function addLabelProductLine() {
            const newProductEntry = document.createElement('div');
            newProductEntry.className = 'label-product-entry grid grid-cols-12 gap-2 items-center';
            newProductEntry.innerHTML = `
                <div class="col-span-3">
                    <input type="number" name="quantity" value="1" min="1" placeholder="Cant." required class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">
                </div>
                <div class="col-span-8">
                    <select name="product" required class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">${productOptionsTemplate.innerHTML}</select>
                </div>
                <div class="col-span-1 text-center">
                    <button type="button" class="remove-label-product-btn text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>
                </div>
            `;
            labelProductsList.appendChild(newProductEntry);
        }

        labelForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const name = document.getElementById('labelName').value;
            const phone = document.getElementById('labelPhone').value;
            const address = document.getElementById('labelAddress').value;
            const price = parseFloat(document.getElementById('labelPrice').value).toFixed(2);
            const paymentMethod = document.getElementById('label-payment-method').value;

            const productEntries = document.querySelectorAll('.label-product-entry');
            let productsHTML = '<ul class="list-disc list-inside pl-1 text-sm">';
            productEntries.forEach(entry => {
                const quantity = entry.querySelector('input[name="quantity"]').value;
                const product = entry.querySelector('select[name="product"]').value;
                if (product.trim()) {
                    productsHTML += `<li>${quantity} x ${product}</li>`;
                }
            });
            productsHTML += '</ul>';

            const labelElement = document.createElement('div');
            labelElement.classList.add('label');
            labelElement.innerHTML = `
                <p><strong>Nombre:</strong> ${name}</p>
                <p><strong>Tel√©fono:</strong> ${phone}</p>
                <p><strong>Direcci√≥n:</strong> ${address}</p>
                <div><strong>Productos:</strong>${productsHTML}</div>
                <p><strong>Total:</strong> $${price}</p>
                <p class="mt-2 pt-2 border-t border-slate-200"><strong>M√©todo de Pago:</strong> ${paymentMethod}</p>
            `;
            labelsContainer.appendChild(labelElement);

            labelForm.reset();
            labelProductsList.innerHTML = '';
            addLabelProductLine();
            document.getElementById('labelName').focus();
        });
        
        addLabelProductBtn.addEventListener('click', addLabelProductLine);
        labelProductsList.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-label-product-btn')) {
                if(labelProductsList.children.length > 1) event.target.closest('.label-product-entry').remove();
            }
        });
        printBtn.addEventListener('click', () => window.print());
        clearBtn.addEventListener('click', () => labelsContainer.innerHTML = '');


        function showMessage(msg, type) {
            messageDiv.textContent = msg;
            if (type === 'success') messageDiv.className = 'flex-grow p-4 rounded-lg text-center text-sm bg-green-100 text-green-800';
            else if (type === 'error') messageDiv.className = 'flex-grow p-4 rounded-lg text-center text-sm bg-red-100 text-red-800';
        }

        // Init
        document.getElementById('productoIngreso').innerHTML = productOptionsTemplate.innerHTML;
        tabInventoryBtn.addEventListener('click', () => switchTab('inventory'));
        tabExpenseBtn.addEventListener('click', () => switchTab('expense'));
        tabLabelsBtn.addEventListener('click', () => switchTab('labels'));
        inventoryForm.addEventListener('submit', handleFormSubmit);
        expenseForm.addEventListener('submit', handleFormSubmit);
        movementRadios.forEach(radio => radio.addEventListener('change', toggleInventoryForms));
        addProductBtn.addEventListener('click', addProductLine);
        productLinesContainer.addEventListener('click', (e) => {
             if (e.target.classList.contains('remove-product-btn')) {
                 e.target.closest('.product-line').remove();
                 updateSaleTotal();
             }
        });
        productLinesContainer.addEventListener('input', (e) => {
            if (e.target.name === 'cantidad' || e.target.name === 'precioUnitario') {
                updateLineAndTotal(e.target.closest('.product-line'));
            }
        });
        
        toggleInventoryForms();
        addLabelProductLine(); // Init label form
    </script>
</body>
</html>
