// Google Apps Script Code (inventory.gs)

// ID de la hoja de cálculo donde se almacenarán los datos.
const SPREADSHEET_ID = '1It4QpvBxQAD0g0IPs-2yaAP6oRMJ068574QXLXcHFvE'; 
const TRANSACTIONS_SHEET_NAME = 'Transacciones';
const STOCK_SHEET_NAME = 'StockActual';

// Esta función se ejecuta cuando el script recibe una petición GET.
// Se usa para obtener el stock actual de un producto.
function doGet(e) {
  try {
    if (e && e.parameter && e.parameter.action === 'getStock' && e.parameter.producto) {
      const productoNombre = e.parameter.producto;
      const stock = getCurrentStock(productoNombre);
      return ContentService.createTextOutput(JSON.stringify({ success: true, stock: stock }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: 'Acción no válida o producto no especificado.' }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    Logger.log('Error en doGet: ' + error.toString() + ' Stack: ' + error.stack);
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: 'Error interno del servidor al procesar doGet: ' + error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// Esta función se ejecuta cuando el script recibe una petición POST (desde el formulario HTML).
function doPost(e) {
  try {
    if (SPREADSHEET_ID === 'TU_SPREADSHEET_ID' || SPREADSHEET_ID === '') { 
      Logger.log('Error: SPREADSHEET_ID no ha sido configurado correctamente en el script.');
      return ContentService.createTextOutput(JSON.stringify({ success: false, error: 'SPREADSHEET_ID no configurado en el script.' }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    const data = JSON.parse(e.postData.contents);

    if (!data.producto || !data.tipoMovimiento || !data.cantidad) {
      Logger.log('Error: Faltan datos en la petición: ' + JSON.stringify(data));
      return ContentService.createTextOutput(JSON.stringify({ success: false, error: 'Faltan datos requeridos.' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    const cantidad = parseInt(data.cantidad, 10);
    if (isNaN(cantidad) || cantidad <= 0) {
        Logger.log('Error: Cantidad inválida: ' + data.cantidad);
        return ContentService.createTextOutput(JSON.stringify({ success: false, error: 'La cantidad debe ser un número positivo.' }))
            .setMimeType(ContentService.MimeType.JSON);
    }

    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const transactionsSheet = ss.getSheetByName(TRANSACTIONS_SHEET_NAME);
    const stockSheet = ss.getSheetByName(STOCK_SHEET_NAME);

    if (!transactionsSheet) {
        Logger.log('Error: No se encontró la hoja "' + TRANSACTIONS_SHEET_NAME + '" en el Spreadsheet ID: ' + SPREADSHEET_ID);
        return ContentService.createTextOutput(JSON.stringify({ success: false, error: 'Hoja de Transacciones no encontrada.' }))
            .setMimeType(ContentService.MimeType.JSON);
    }
    if (!stockSheet) {
        Logger.log('Error: No se encontró la hoja "' + STOCK_SHEET_NAME + '" en el Spreadsheet ID: ' + SPREADSHEET_ID);
        return ContentService.createTextOutput(JSON.stringify({ success: false, error: 'Hoja de StockActual no encontrada.' }))
            .setMimeType(ContentService.MimeType.JSON);
    }

    const stockData = stockSheet.getDataRange().getValues();
    let productRowIndex = -1;
    let currentStock = 0; // Initialize currentStock

    for (let i = 1; i < stockData.length; i++) { // Start from 1 to skip header row
      if (stockData[i][0] === data.producto) {
        productRowIndex = i + 1; // Sheet rows are 1-indexed
        currentStock = parseInt(stockData[i][1], 10);
        if (isNaN(currentStock)) { 
            currentStock = 0; 
            Logger.log('Advertencia: Stock para "' + data.producto + '" no era un número. Se asumió 0.');
        }
        break;
      }
    }

    if (productRowIndex === -1) {
      Logger.log('Error: Producto no encontrado en la hoja StockActual: ' + data.producto);
      return ContentService.createTextOutput(JSON.stringify({ success: false, error: 'Producto no encontrado en la hoja de stock. Asegúrate de que esté listado en la hoja "StockActual".' }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    let newStock = currentStock;

    if (data.tipoMovimiento === 'Salida') {
      if (currentStock < cantidad) {
        Logger.log('Error: Stock insuficiente para ' + data.producto + '. Stock actual: ' + currentStock + ', Salida solicitada: ' + cantidad);
        // Return error BEFORE any sheet modification for this transaction
        return ContentService.createTextOutput(JSON.stringify({ success: false, error: 'STOCK_INSUFICIENTE', currentStock: currentStock, productName: data.producto }))
          .setMimeType(ContentService.MimeType.JSON);
      }
      newStock -= cantidad;
    } else if (data.tipoMovimiento === 'Ingreso') {
      newStock += cantidad;
    }

    // If we've reached here, the operation is valid (either Ingreso or Salida with enough stock)
    const timestamp = new Date();
    transactionsSheet.appendRow([
      timestamp,
      data.producto,
      data.tipoMovimiento,
      cantidad,
      data.tipoMovimiento === 'Salida' ? data.precioVenta || 0 : '',
      data.tipoMovimiento === 'Salida' ? data.descripcionVenta || '' : ''
    ]);

    stockSheet.getRange(productRowIndex, 2).setValue(newStock); 

    SpreadsheetApp.flush(); 

    return ContentService.createTextOutput(JSON.stringify({ success: true, message: 'Movimiento registrado.' }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    Logger.log('Error en doPost: ' + error.toString() + ' Stack: ' + error.stack);
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: 'Ocurrió un error en el servidor: ' + error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function getCurrentStock(productName) {
  if (SPREADSHEET_ID === 'TU_SPREADSHEET_ID' || SPREADSHEET_ID === '') {
    Logger.log('Error en getCurrentStock: SPREADSHEET_ID no ha sido configurado.');
    return 'ID Hoja No Configurado'; 
  }
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const stockSheet = ss.getSheetByName(STOCK_SHEET_NAME);
     if (!stockSheet) {
        Logger.log('Error en getCurrentStock: No se encontró la hoja "' + STOCK_SHEET_NAME + '"');
        return 'Hoja Stock No Encontrada';
    }
    const stockData = stockSheet.getDataRange().getValues();
    for (let i = 1; i < stockData.length; i++) {
      if (stockData[i][0] === productName) {
        let stockValue = stockData[i][1];
        return !isNaN(parseFloat(stockValue)) && isFinite(stockValue) ? parseFloat(stockValue) : 0;
      }
    }
    return 0; 
  } catch (error) {
    Logger.log('Error al obtener stock para ' + productName + ': ' + error.toString());
    return 'Error'; 
  }
}

function setup() {
  if (SPREADSHEET_ID === 'TU_SPREADSHEET_ID' || SPREADSHEET_ID === '') {
    SpreadsheetApp.getUi().alert('Configuración Necesaria', 'Por favor, edita el script y reemplaza "TU_SPREADSHEET_ID" (o configúralo si está vacío) con el ID real de tu Google Sheet antes de ejecutar setup.', SpreadsheetApp.getUi().ButtonSet.OK);
    return;
  }
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  
  let transactionsSheet = ss.getSheetByName(TRANSACTIONS_SHEET_NAME);
  if (!transactionsSheet) {
    transactionsSheet = ss.insertSheet(TRANSACTIONS_SHEET_NAME);
    transactionsSheet.appendRow(['Timestamp', 'Producto', 'Tipo Movimiento', 'Cantidad', 'Precio Venta (Total)', 'Descripción Venta']);
    transactionsSheet.getRange("A:F").applyRowBanding(SpreadsheetApp.BandingTheme.LIGHT_GREY, true, false);
    transactionsSheet.setFrozenRows(1);
    transactionsSheet.getRange("A1:F1").setFontWeight("bold"); 
    transactionsSheet.setColumnWidth(1, 150); 
    transactionsSheet.setColumnWidth(2, 250); 
    transactionsSheet.setColumnWidth(3, 150); 
    transactionsSheet.setColumnWidth(5, 150); 
    transactionsSheet.setColumnWidth(6, 300); 
     Logger.log('Hoja "' + TRANSACTIONS_SHEET_NAME + '" creada y configurada.');
  } else {
     Logger.log('Hoja "' + TRANSACTIONS_SHEET_NAME + '" ya existe.');
  }

  let stockSheet = ss.getSheetByName(STOCK_SHEET_NAME);
  if (!stockSheet) {
    stockSheet = ss.insertSheet(STOCK_SHEET_NAME);
    stockSheet.appendRow(['Producto', 'Stock']);
    const productos = [
      "Miel Picante Nivel 1 botella 350 ml", "Miel Picante Nivel 2 botella 350 ml", "Miel Picante Nivel 3 botella 350 ml",
      "Miel Picante Nivel 1 sachet", "Miel Picante Nivel 2 sachet", "Miel Picante Nivel 3 sachet",
      "Miel Picante Nivel 1 galon", "Miel Picante Nivel 2 galon", "Miel Picante Nivel 3 galon"
    ];
    productos.forEach(p => stockSheet.appendRow([p, 0])); 
    stockSheet.getRange("A:B").applyRowBanding(SpreadsheetApp.BandingTheme.CYAN, true, false);
    stockSheet.setFrozenRows(1);
    stockSheet.getRange("A1:B1").setFontWeight("bold"); 
    stockSheet.setColumnWidth(1, 250); 
    stockSheet.setColumnWidth(2, 100); 
    Logger.log('Hoja "' + STOCK_SHEET_NAME + '" creada, configurada y poblada con productos.');
  } else {
    const existingProductsData = stockSheet.getRange(2, 1, stockSheet.getLastRow() > 1 ? stockSheet.getLastRow() -1 : 1 , 1).getValues(); // Check if sheet has more than header
    const existingProductsList = existingProductsData.map(row => row[0]);
    const productosBase = [
      "Miel Picante Nivel 1 botella 350 ml", "Miel Picante Nivel 2 botella 350 ml", "Miel Picante Nivel 3 botella 350 ml",
      "Miel Picante Nivel 1 sachet", "Miel Picante Nivel 2 sachet", "Miel Picante Nivel 3 sachet",
      "Miel Picante Nivel 1 galon", "Miel Picante Nivel 2 galon", "Miel Picante Nivel 3 galon"
    ];
    let productsAdded = 0;
    productosBase.forEach(p => {
      if (!existingProductsList.includes(p)) {
        stockSheet.appendRow([p, 0]);
        productsAdded++;
      }
    });
    if (productsAdded > 0) {
      Logger.log(productsAdded + ' producto(s) nuevo(s) agregado(s) a la hoja "' + STOCK_SHEET_NAME + '".');
    } else {
      Logger.log('Hoja "' + STOCK_SHEET_NAME + '" ya existe y todos los productos base están listados.');
    }
  }
  SpreadsheetApp.getUi().alert('Configuración Completada', 'Las hojas necesarias han sido verificadas/creadas y los productos actualizados. Asegúrate de que "SPREADSHEET_ID" esté correctamente configurado en el script.', SpreadsheetApp.getUi().ButtonSet.OK);
}

