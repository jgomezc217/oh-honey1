<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Inventario y Gastos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-button.active { border-bottom-color: #3b82f6; color: #1e40af; font-weight: 600; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white shadow-2xl rounded-xl p-6 md:p-10 w-full max-w-3xl">
        <header class="mb-6 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-700">üçØ Control Financiero y de Inventario</h1>
            <p class="text-slate-600 mt-2">Gestiona tu inventario y registra tus gastos.</p>
        </header>

        <div class="border-b border-slate-200 mb-6">
            <nav class="flex -mb-px space-x-6">
                <button id="tabInventoryBtn" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300">Movimientos de Inventario</button>
                <button id="tabExpenseBtn" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300">Registro de Gastos</button>
            </nav>
        </div>

        <!-- Contenido de Inventario -->
        <div id="inventoryContent">
            <form id="inventoryForm">
                <input type="hidden" name="formType" value="inventory">
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Tipo de Movimiento:</label>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center"><input type="radio" name="tipoMovimiento" value="Ingreso" required checked class="h-4 w-4 text-sky-600 border-slate-300 focus:ring-sky-500"><span class="ml-2 text-slate-700">Ingreso</span></label>
                            <label class="flex items-center"><input type="radio" name="tipoMovimiento" value="Venta" required class="h-4 w-4 text-sky-600 border-slate-300 focus:ring-sky-500"><span class="ml-2 text-slate-700">Venta</span></label>
                        </div>
                    </div>

                    <!-- FORMULARIO DE INGRESO (SIMPLE) -->
                    <div id="formIngreso" class="space-y-4">
                        <div>
                            <label for="productoIngreso" class="block text-sm font-medium text-slate-700 mb-1">Producto:</label>
                             <select id="productoIngreso" name="producto" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500">
                                <!-- Opciones se clonan aqu√≠ -->
                            </select>
                        </div>
                        <div>
                            <label for="cantidadIngreso" class="block text-sm font-medium text-slate-700 mb-1">Cantidad:</label>
                            <input type="number" id="cantidadIngreso" name="cantidad" min="1" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500" placeholder="Ej: 10">
                        </div>
                    </div>

                    <!-- FORMULARIO DE VENTA (M√öLTIPLE) -->
                    <div id="formVenta" class="hidden space-y-6">
                         <div>
                            <label for="numeroFactura" class="block text-sm font-medium text-slate-700 mb-1">N√∫mero de Factura:</label>
                            <input type="text" id="numeroFactura" name="numeroFactura" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500" placeholder="Ej: 001-001-0001234">
                        </div>
                        <div id="productLines" class="space-y-4 border-t border-b border-slate-200 py-4">
                            <!-- Las l√≠neas de producto se agregar√°n aqu√≠ -->
                        </div>
                        <div class="flex justify-between items-center">
                            <button type="button" id="addProductBtn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-lg shadow-sm">+ A√±adir Producto</button>
                            <div class="text-right">
                                <p class="text-slate-600">Total de la Venta:</p>
                                <p id="saleTotal" class="text-2xl font-bold text-slate-800">$0.00</p>
                            </div>
                        </div>
                        <div>
                            <label for="descripcionVenta" class="block text-sm font-medium text-slate-700 mb-1">Descripci√≥n de la Venta:</label>
                            <textarea id="descripcionVenta" name="descripcionVenta" rows="2" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500" placeholder="Ej: Venta a cliente minorista"></textarea>
                        </div>
                    </div>
                </div>
                <div class="flex items-center justify-end pt-6"><button type="submit" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2">Registrar Movimiento</button></div>
            </form>
        </div>
        
        <!-- Contenido de Gastos -->
        <div id="expenseContent" class="hidden">
           <!-- El formulario de gastos sigue igual -->
            <form id="expenseForm" class="space-y-6">
                <input type="hidden" name="formType" value="expense">
                <div>
                    <label for="tipoGasto" class="block text-sm font-medium text-slate-700 mb-1">Tipo de Gasto:</label>
                    <select id="tipoGasto" name="tipoGasto" required class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                        <option value="" disabled selected>Selecciona un tipo...</option>
                        <option value="Transporte">Transporte</option>
                        <option value="Material de Empaque">Material de Empaque</option>
                        <option value="Insumos">Insumos</option>
                        <option value="Publicidad">Publicidad</option>
                        <option value="Servicios (Luz, Agua, etc.)">Servicios (Luz, Agua, etc.)</option>
                        <option value="Salarios">Salarios</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                <div>
                    <label for="valorGasto" class="block text-sm font-medium text-slate-700 mb-1">Valor del Gasto Total (IVA Incluido):</label>
                    <input type="number" id="valorGasto" name="valorGasto" required step="0.01" min="0" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Ej: 50.75">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">M√©todo de Pago:</label>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center"><input type="radio" name="metodoPago" value="Efectivo" required checked class="h-4 w-4 text-sky-600 border-slate-300 focus:ring-sky-500"><span class="ml-2 text-slate-700">Efectivo</span></label>
                        <label class="flex items-center"><input type="radio" name="metodoPago" value="Tarjeta" required class="h-4 w-4 text-sky-600 border-slate-300 focus:ring-sky-500"><span class="ml-2 text-slate-700">Tarjeta</span></label>
                    </div>
                </div>
                <div>
                    <label for="descripcionGasto" class="block text-sm font-medium text-slate-700 mb-1">Descripci√≥n del Gasto:</label>
                    <textarea id="descripcionGasto" name="descripcionGasto" required rows="3" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Ej: Compra de cajas para env√≠o"></textarea>
                </div>
                <div class="flex items-center justify-end pt-4"><button type="submit" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2">Registrar Gasto</button></div>
            </form>
        </div>

        <div class="flex items-center justify-end space-x-3 mt-6">
            <div id="loader" class="loader"></div>
            <div id="message" class="flex-grow p-4 rounded-lg text-center text-sm" role="alert"></div>
        </div>
    </div>
    
    <template id="productOptionsTemplate">
        <option value="" disabled selected>Selecciona un producto...</option>
        <option value="Miel Picante Nivel 1 botella 350 ml">Miel Picante Nivel 1 botella 350 ml</option>
        <option value="Miel Picante Nivel 2 botella 350 ml">Miel Picante Nivel 2 botella 350 ml</option>
        <option value="Miel Picante Nivel 3 botella 350 ml">Miel Picante Nivel 3 botella 350 ml</option>
        <option value="Miel Picante Nivel 1 sachet">Miel Picante Nivel 1 sachet</option>
        <option value="Miel Picante Nivel 2 sachet">Miel Picante Nivel 2 sachet</option>
        <option value="Miel Picante Nivel 3 sachet">Miel Picante Nivel 3 sachet</option>
        <option value="Miel Picante Nivel 1 galon">Miel Picante Nivel 1 gal√≥n</option>
        <option value="Miel Picante Nivel 2 galon">Miel Picante Nivel 2 gal√≥n</option>
        <option value="Miel Picante Nivel 3 galon">Miel Picante Nivel 3 gal√≥n</option>
    </template>

    <script>
        const FULL_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxMapJvU3t9B7c0sfZIQRJbjPZpqjVVQCF9gsJrQd4evSVDCeNnPKlRfdkPLoxkZE8JyA/exec';
        
        const tabInventoryBtn = document.getElementById('tabInventoryBtn');
        const tabExpenseBtn = document.getElementById('tabExpenseBtn');
        const inventoryContent = document.getElementById('inventoryContent');
        const expenseContent = document.getElementById('expenseContent');
        const inventoryForm = document.getElementById('inventoryForm');
        const expenseForm = document.getElementById('expenseForm');
        const messageDiv = document.getElementById('message');
        const loader = document.getElementById('loader');
        const movementRadios = document.querySelectorAll('input[name="tipoMovimiento"]');
        const formIngreso = document.getElementById('formIngreso');
        const formVenta = document.getElementById('formVenta');
        const productLinesContainer = document.getElementById('productLines');
        const addProductBtn = document.getElementById('addProductBtn');
        const saleTotalEl = document.getElementById('saleTotal');
        const productOptionsTemplate = document.getElementById('productOptionsTemplate');
        
        tabInventoryBtn.addEventListener('click', () => switchTab('inventory'));
        tabExpenseBtn.addEventListener('click', () => switchTab('expense'));
        function switchTab(activeTab) {
            messageDiv.textContent = ''; messageDiv.className = 'flex-grow p-4 rounded-lg text-center text-sm';
            if (activeTab === 'inventory') {
                tabInventoryBtn.classList.add('active'); tabExpenseBtn.classList.remove('active');
                inventoryContent.classList.remove('hidden'); expenseContent.classList.add('hidden');
            } else {
                tabInventoryBtn.classList.remove('active'); tabExpenseBtn.classList.add('active');
                inventoryContent.classList.add('hidden'); expenseContent.classList.remove('hidden');
            }
        }

        movementRadios.forEach(radio => radio.addEventListener('change', toggleInventoryForms));
        function toggleInventoryForms() {
            const selectedValue = document.querySelector('input[name="tipoMovimiento"]:checked').value;
            if (selectedValue === 'Venta') {
                formVenta.classList.remove('hidden');
                formIngreso.classList.add('hidden');
                if (productLinesContainer.children.length === 0) addProductLine();
            } else {
                formVenta.classList.add('hidden');
                formIngreso.classList.remove('hidden');
            }
        }
        
        addProductBtn.addEventListener('click', addProductLine);
        productLinesContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-product-btn')) {
                e.target.closest('.product-line').remove();
                updateSaleTotal();
            }
        });
        productLinesContainer.addEventListener('input', updateSaleTotal);
        
        function addProductLine() {
            const lineDiv = document.createElement('div');
            lineDiv.className = 'product-line grid grid-cols-12 gap-2 items-center border-t pt-3 first:border-t-0 first:pt-0';
            lineDiv.innerHTML = `
                <div class="col-span-12 sm:col-span-4">
                    <label class="sr-only">Producto</label>
                    <select name="producto" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-1 focus:ring-sky-500">${productOptionsTemplate.innerHTML}</select>
                </div>
                <div class="col-span-4 sm:col-span-2">
                     <label class="sr-only">Cantidad</label>
                    <input type="number" name="cantidad" min="1" placeholder="Cant." class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-1 focus:ring-sky-500">
                </div>
                <div class="col-span-8 sm:col-span-3">
                     <label class="sr-only">Precio</label>
                    <input type="number" name="precioVenta" step="0.01" min="0" placeholder="Precio" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-1 focus:ring-sky-500">
                </div>
                <div class="col-span-10 sm:col-span-2 flex items-center justify-start sm:justify-center">
                    <input type="checkbox" name="incluyeIVA" checked class="h-4 w-4 text-sky-600 border-slate-300 rounded focus:ring-sky-500">
                    <label class="ml-2 text-xs text-slate-600">Incl. IVA</label>
                </div>
                <div class="col-span-2 sm:col-span-1 flex justify-end">
                    <button type="button" class="remove-product-btn text-red-500 hover:text-red-700 font-bold p-2 rounded-full leading-none">‚úï</button>
                </div>
            `;
            productLinesContainer.appendChild(lineDiv);
        }

        function updateSaleTotal() {
            const lines = document.querySelectorAll('.product-line');
            let total = 0;
            lines.forEach(line => {
                const priceInput = line.querySelector('input[name="precioVenta"]');
                const includesIVA = line.querySelector('input[name="incluyeIVA"]').checked;
                const price = parseFloat(priceInput.value) || 0;
                total += includesIVA ? price : price * 1.13;
            });
            saleTotalEl.textContent = `$${total.toFixed(2)}`;
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            loader.style.display = 'block';
            messageDiv.textContent = ''; messageDiv.className = 'flex-grow p-4 rounded-lg text-center text-sm';
            
            const formElement = e.target;
            const formData = new FormData(formElement);
            let data;
            
            const movementType = formData.get('tipoMovimiento');
            
            if(formElement.id === 'inventoryForm' && movementType === 'Venta') {
                const productLines = document.querySelectorAll('#productLines .product-line');
                const productos = Array.from(productLines).map(line => ({
                    producto: line.querySelector('select[name="producto"]').value,
                    cantidad: line.querySelector('input[name="cantidad"]').value,
                    precioVenta: line.querySelector('input[name="precioVenta"]').value,
                    incluyeIVA: line.querySelector('input[name="incluyeIVA"]').checked,
                }));
                
                if (productos.some(p => !p.producto || !p.cantidad || !p.precioVenta)) {
                   showMessage('Por favor, complete todos los campos para cada producto.', 'error');
                   loader.style.display = 'none';
                   return;
                }

                data = {
                    formType: 'inventory',
                    tipoMovimiento: 'Venta',
                    numeroFactura: formData.get('numeroFactura'),
                    descripcionVenta: formData.get('descripcionVenta'),
                    productos: productos
                };
            } else {
                 data = Object.fromEntries(formData.entries());
            }

            try {
                const response = await fetch(FULL_SCRIPT_URL, {
                    method: 'POST', mode: 'cors', cache: 'no-cache', redirect: 'follow', body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    showMessage(result.message || '¬°Operaci√≥n registrada!', 'success');
                    formElement.reset();
                    if(formElement.id === 'inventoryForm' && movementType === 'Venta') {
                         productLinesContainer.innerHTML = '';
                         addProductLine();
                         updateSaleTotal();
                    }
                    toggleInventoryForms();
                } else {
                    let errorMessage = result.error || 'Error desconocido.';
                    if (result.error === 'STOCK_INSUFICIENTE') {
                        errorMessage = `Error: Stock insuficiente para '${result.producto}'. Stock actual: ${result.currentStock}.`;
                    }
                    showMessage(errorMessage, 'error');
                }
            } catch (error) {
                showMessage(`Error de conexi√≥n: ${error.message}.`, 'error');
            } finally {
                loader.style.display = 'none';
            }
        }
        inventoryForm.addEventListener('submit', handleFormSubmit);
        expenseForm.addEventListener('submit', handleFormSubmit);

        function showMessage(msg, type) {
            messageDiv.textContent = msg;
            if (type === 'success') messageDiv.className = 'flex-grow p-4 rounded-lg text-center text-sm bg-green-100 text-green-800';
            else if (type === 'error') messageDiv.className = 'flex-grow p-4 rounded-lg text-center text-sm bg-red-100 text-red-800';
        }

        document.getElementById('productoIngreso').innerHTML = productOptionsTemplate.innerHTML;
        toggleInventoryForms();
    </script>
</body>
</html>

