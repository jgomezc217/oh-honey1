/**
 * @OnlyCurrentDoc
 */

const SPREADSHEET_ID = '1It4QpvBxQAD0g0IPs-2yaAP6oRMJ068574QXLXcHFvE';
const IVA_RATE = 0.13;

const TRANSACTIONS_SHEET_NAME = 'Transacciones';
const STOCK_SHEET_NAME = 'StockActual';
const EXPENSE_SHEET_NAME = 'Gastos';

const productList = [
  "Miel Picante Baja botella 350 g",
  "Miel Picante Media botella 350 g",
  "Miel Picante Alta botella 350 g",
  "Miel Picante Baja sachet",
  "Miel Picante Media sachet",
  "Miel Picante Alta sachet",
  "Miel Picante Baja galón",
  "Miel Picante Media galón",
  "Miel Picante Alta galón"
];

function setup() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const transactionsHeaders = ["Fecha", "Hora", "Producto", "Tipo Movimiento", "Cantidad", "Número de Factura", "Precio Venta (Sin IVA)", "IVA (13%)", "Precio Venta Total", "Comisión POS", "Descripción Venta"];
  let transactionsSheet = ss.getSheetByName(TRANSACTIONS_SHEET_NAME);
  if (!transactionsSheet) {
    transactionsSheet = ss.insertSheet(TRANSACTIONS_SHEET_NAME);
  }
  updateHeaders(transactionsSheet, transactionsHeaders);

  const stockHeaders = ["Producto", "Stock"];
  let stockSheet = ss.getSheetByName(STOCK_SHEET_NAME);
  if (!stockSheet) {
    stockSheet = ss.insertSheet(STOCK_SHEET_NAME);
    updateHeaders(stockSheet, stockHeaders);
  }
  
  const stockData = stockSheet.getRange(2, 1, stockSheet.getLastRow(), 1).getValues().flat();
  productList.forEach(product => {
    if (!stockData.includes(product)) {
      stockSheet.appendRow([product, 0]);
    }
  });

  const expenseHeaders = ["Fecha", "Hora", "Tipo de Gasto", "Descripción", "Método de Pago", "Gasto (Sin IVA)", "IVA (13%)", "Gasto Total"];
  let expenseSheet = ss.getSheetByName(EXPENSE_SHEET_NAME);
  if (!expenseSheet) {
    expenseSheet = ss.insertSheet(EXPENSE_SHEET_NAME);
  }
  updateHeaders(expenseSheet, expenseHeaders);
}

function updateHeaders(sheet, headers) {
    const currentHeaders = sheet.getRange(1, 1, 1, sheet.getMaxColumns()).getValues()[0];
    if (currentHeaders.length < headers.length || currentHeaders[headers.length-1] !== headers[headers.length-1]) {
        sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
    }
}

function doGet(e) {
  try {
    if (e.parameter.action == 'getStock') {
      const productName = e.parameter.producto;
      if (!productName) return createJsonResponse({ success: false, error: 'Producto no especificado', stock: 0 });
      const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
      const stockSheet = ss.getSheetByName(STOCK_SHEET_NAME);
      const stockData = stockSheet.getRange(2, 1, stockSheet.getLastRow(), 2).getValues();
      const productRow = stockData.find(row => row[0] === productName);
      if (productRow) return createJsonResponse({ success: true, stock: productRow[1] });
      else return createJsonResponse({ success: false, error: 'Producto no encontrado', stock: 0 });
    }
    return createJsonResponse({ success: false, error: 'Acción no válida' });
  } catch (error) {
    return createJsonResponse({ success: false, error: `Error en GET: ${error.message}` });
  }
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    if (data.formType === 'inventory') return handleInventory(data);
    else if (data.formType === 'expense') return handleExpense(data);
  } catch (error) {
    return createJsonResponse({ success: false, error: `Error en el servidor: ${error.message}` });
  }
}

function handleInventory(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const stockSheet = ss.getSheetByName(STOCK_SHEET_NAME);
  const transactionsSheet = ss.getSheetByName(TRANSACTIONS_SHEET_NAME);
  
  const stockData = stockSheet.getRange(2, 1, stockSheet.getLastRow(), 2).getValues();
  const stockMap = new Map(stockData.map((row, i) => [row[0], { stock: row[1], rowIndex: i + 2 }]));

  const now = new Date();
  const fecha = Utilities.formatDate(now, "GMT-6", "MM/dd/yy");
  const hora = Utilities.formatDate(now, "GMT-6", "HH:mm:ss");

  if (data.tipoMovimiento === 'Ingreso') {
    const { producto, cantidad } = data;
    const stockInfo = stockMap.get(producto);
    if (stockInfo) {
      const newStock = Number(stockInfo.stock) + Number(cantidad);
      stockSheet.getRange(stockInfo.rowIndex, 2).setValue(newStock);
      transactionsSheet.appendRow([fecha, hora, producto, 'Ingreso', cantidad, '', '', '', '', '', '']); 
    }
  } else if (data.tipoMovimiento === 'Venta') {
    const movimiento = data.esMuestra ? 'Muestra' : 'Venta';
    const { pagoConPOS, comisionPOS, incluyeDelivery, montoDelivery } = data;
    const comisionPorcentaje = (pagoConPOS && comisionPOS) ? parseFloat(comisionPOS) / 100 : 0;

    // Validar stock
    for (const item of data.productos) {
      const stockInfo = stockMap.get(item.producto);
      if (!stockInfo || Number(stockInfo.stock) < Number(item.cantidad)) {
        return createJsonResponse({ success: false, error: 'STOCK_INSUFICIENTE', producto: item.producto, currentStock: stockInfo ? stockInfo.stock : 0 });
      }
    }
    
    // Procesar productos
    data.productos.forEach(item => {
      const { producto, cantidad, precioUnitario, incluyeIVA } = item;
      const precioTotalPorLineaBruto = Number(cantidad) * Number(precioUnitario);
      
      let precioSinIVA, ivaMonto, precioTotalRegistrado, comisionMonto = 0;

      if (movimiento === 'Muestra') {
          precioSinIVA = 0;
          ivaMonto = 0;
          precioTotalRegistrado = 0;
      } else {
          let totalBruto;
          if (incluyeIVA) {
             totalBruto = precioTotalPorLineaBruto;
             precioSinIVA = totalBruto / (1 + IVA_RATE);
             ivaMonto = totalBruto - precioSinIVA;
          } else {
             precioSinIVA = precioTotalPorLineaBruto;
             ivaMonto = 0;
             totalBruto = precioSinIVA;
          }

          if (comisionPorcentaje > 0) {
              comisionMonto = totalBruto * comisionPorcentaje;
          }
          precioTotalRegistrado = totalBruto - comisionMonto;
      }

      const stockInfo = stockMap.get(producto);
      const newStock = Number(stockInfo.stock) - Number(cantidad);
      stockSheet.getRange(stockInfo.rowIndex, 2).setValue(newStock);
      
      transactionsSheet.appendRow([
        fecha, hora, producto, movimiento, cantidad, 
        data.numeroFactura, 
        movimiento === 'Muestra' ? 0 : precioSinIVA.toFixed(2), 
        movimiento === 'Muestra' ? 0 : ivaMonto.toFixed(2), 
        movimiento === 'Muestra' ? 0 : precioTotalRegistrado.toFixed(2),
        comisionMonto > 0 ? comisionMonto.toFixed(2) : '',
        data.descripcionVenta
      ]);
    });

    // Procesar Delivery (NETO, sin comisión POS)
    if (incluyeDelivery && montoDelivery) {
        let deliveryVal = parseFloat(montoDelivery);
        
        transactionsSheet.appendRow([
            fecha, 
            hora, 
            "Delivery", 
            "Venta", 
            1, 
            data.numeroFactura, 
            deliveryVal.toFixed(2), // Precio Sin IVA
            0, // IVA
            deliveryVal.toFixed(2), // Precio Venta Total (Neto)
            "", // Comisión POS vacía
            "Servicio de Delivery"
        ]);
    }
  }
  
  return createJsonResponse({ success: true, message: `¡Operación registrada con éxito!` });
}

function handleExpense(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const expenseSheet = ss.getSheetByName(EXPENSE_SHEET_NAME);
  const { tipoGasto, valorGasto, gastoIncluyeIVA, metodoPago, descripcionGasto } = data;

  let gastoSinIVA, ivaMonto, gastoTotal;
  const val = parseFloat(valorGasto);

  if (gastoIncluyeIVA) {
      gastoTotal = val;
      gastoSinIVA = gastoTotal / (1 + IVA_RATE);
      ivaMonto = gastoTotal - gastoSinIVA;
  } else {
      gastoSinIVA = val;
      ivaMonto = 0;
      gastoTotal = val;
  }

  const now = new Date();
  const fecha = Utilities.formatDate(now, "GMT-6", "MM/dd/yy");
  const hora = Utilities.formatDate(now, "GMT-6", "HH:mm:ss");

  expenseSheet.appendRow([
    fecha, hora, tipoGasto, descripcionGasto, metodoPago,
    gastoSinIVA.toFixed(2), ivaMonto.toFixed(2), gastoTotal.toFixed(2)
  ]);
  
  return createJsonResponse({ success: true, message: 'Gasto registrado con éxito.' });
}

function createJsonResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}
