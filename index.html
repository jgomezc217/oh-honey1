<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Inventario y Gastos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-button.active {
            border-bottom-color: #3b82f6; /* blue-600 */
            color: #1e40af; /* blue-800 */
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white shadow-2xl rounded-xl p-6 md:p-10 w-full max-w-2xl">
        <header class="mb-6 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-700">🍯 Control Financiero y de Inventario</h1>
            <p class="text-slate-600 mt-2">Gestiona tu inventario y registra tus gastos.</p>
        </header>

        <!-- Pestañas -->
        <div class="border-b border-slate-200 mb-6">
            <nav class="flex -mb-px space-x-6">
                <button id="tabInventoryBtn" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300">
                    Movimientos de Inventario
                </button>
                <button id="tabExpenseBtn" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300">
                    Registro de Gastos
                </button>
            </nav>
        </div>

        <!-- Contenido de Inventario -->
        <div id="inventoryContent">
            <form id="inventoryForm" class="space-y-6">
                <input type="hidden" name="formType" value="inventory">
                <div>
                    <label for="producto" class="block text-sm font-medium text-slate-700 mb-1">Producto:</label>
                    <select id="producto" name="producto" required class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition duration-150 ease-in-out bg-white">
                        <option value="" disabled selected>Selecciona un producto...</option>
                        <option value="Miel Picante Nivel 1 botella 350 ml">Miel Picante Nivel 1 botella 350 ml</option>
                        <option value="Miel Picante Nivel 2 botella 350 ml">Miel Picante Nivel 2 botella 350 ml</option>
                        <option value="Miel Picante Nivel 3 botella 350 ml">Miel Picante Nivel 3 botella 350 ml</option>
                        <option value="Miel Picante Nivel 1 sachet">Miel Picante Nivel 1 sachet</option>
                        <option value="Miel Picante Nivel 2 sachet">Miel Picante Nivel 2 sachet</option>
                        <option value="Miel Picante Nivel 3 sachet">Miel Picante Nivel 3 sachet</option>
                        <option value="Miel Picante Nivel 1 galon">Miel Picante Nivel 1 galón</option>
                        <option value="Miel Picante Nivel 2 galon">Miel Picante Nivel 2 galón</option>
                        <option value="Miel Picante Nivel 3 galon">Miel Picante Nivel 3 galón</option>
                    </select>
                    <div class="mt-2 text-sm text-slate-600">
                        Stock Actual: <span id="stockActual" class="font-semibold">N/A</span>
                        <button type="button" id="refreshStockBtn" class="ml-2 text-xs px-2 py-1 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 transition-colors">Actualizar Stock</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Tipo de Movimiento:</label>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center"><input type="radio" name="tipoMovimiento" value="Ingreso" required checked class="h-4 w-4 text-sky-600 border-slate-300 focus:ring-sky-500"><span class="ml-2 text-slate-700">Ingreso</span></label>
                        <label class="flex items-center"><input type="radio" name="tipoMovimiento" value="Salida" required class="h-4 w-4 text-sky-600 border-slate-300 focus:ring-sky-500"><span class="ml-2 text-slate-700">Salida</span></label>
                    </div>
                </div>
                <div>
                    <label for="cantidad" class="block text-sm font-medium text-slate-700 mb-1">Cantidad:</label>
                    <input type="number" id="cantidad" name="cantidad" required min="1" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Ej: 10">
                </div>
                <div id="camposSalida" class="space-y-6 hidden">
                    <div><label for="precioVenta" class="block text-sm font-medium text-slate-700 mb-1">Precio de Venta (Total):</label><input type="number" id="precioVenta" name="precioVenta" step="0.01" min="0" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Ej: 25.50"></div>
                    <div><label for="descripcionVenta" class="block text-sm font-medium text-slate-700 mb-1">Descripción de la Venta/Salida:</label><textarea id="descripcionVenta" name="descripcionVenta" rows="3" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Ej: Venta a cliente minorista"></textarea></div>
                </div>
                <div class="flex items-center justify-end pt-4"><button type="submit" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2">Registrar Movimiento</button></div>
            </form>
        </div>

        <!-- Contenido de Gastos -->
        <div id="expenseContent" class="hidden">
            <form id="expenseForm" class="space-y-6">
                <input type="hidden" name="formType" value="expense">
                <div>
                    <label for="tipoGasto" class="block text-sm font-medium text-slate-700 mb-1">Tipo de Gasto:</label>
                    <select id="tipoGasto" name="tipoGasto" required class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                        <option value="" disabled selected>Selecciona un tipo...</option>
                        <option value="Transporte">Transporte</option>
                        <option value="Material de Empaque">Material de Empaque</option>
                        <option value="Insumos">Insumos</option>
                        <option value="Publicidad">Publicidad</option>
                        <option value="Servicios (Luz, Agua, etc.)">Servicios (Luz, Agua, etc.)</option>
                        <option value="Salarios">Salarios</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                <div>
                    <label for="valorGasto" class="block text-sm font-medium text-slate-700 mb-1">Valor del Gasto (USD):</label>
                    <input type="number" id="valorGasto" name="valorGasto" required step="0.01" min="0" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Ej: 50.75">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Método de Pago:</label>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center"><input type="radio" name="metodoPago" value="Efectivo" required checked class="h-4 w-4 text-sky-600 border-slate-300 focus:ring-sky-500"><span class="ml-2 text-slate-700">Efectivo</span></label>
                        <label class="flex items-center"><input type="radio" name="metodoPago" value="Tarjeta" required class="h-4 w-4 text-sky-600 border-slate-300 focus:ring-sky-500"><span class="ml-2 text-slate-700">Tarjeta</span></label>
                    </div>
                </div>
                <div>
                    <label for="descripcionGasto" class="block text-sm font-medium text-slate-700 mb-1">Descripción del Gasto:</label>
                    <textarea id="descripcionGasto" name="descripcionGasto" required rows="3" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Ej: Compra de cajas para envío"></textarea>
                </div>
                <div class="flex items-center justify-end pt-4"><button type="submit" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2">Registrar Gasto</button></div>
            </form>
        </div>

        <!-- Contenedor de mensajes y loader -->
        <div class="flex items-center justify-end space-x-3 mt-6">
            <div id="loader" class="loader"></div>
            <div id="message" class="flex-grow p-4 rounded-lg text-center text-sm" role="alert"></div>
        </div>
    </div>

    <script>
        const FULL_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxMapJvU3t9B7c0sfZIQRJbjPZpqjVVQCF9gsJrQd4evSVDCeNnPKlRfdkPLoxkZE8JyA/exec';
        
        // Elementos del DOM
        const inventoryForm = document.getElementById('inventoryForm');
        const expenseForm = document.getElementById('expenseForm');
        const messageDiv = document.getElementById('message');
        const loader = document.getElementById('loader');

        // Lógica de pestañas
        const tabInventoryBtn = document.getElementById('tabInventoryBtn');
        const tabExpenseBtn = document.getElementById('tabExpenseBtn');
        const inventoryContent = document.getElementById('inventoryContent');
        const expenseContent = document.getElementById('expenseContent');

        function switchTab(activeTab) {
            messageDiv.textContent = '';
            messageDiv.className = 'flex-grow p-4 rounded-lg text-center text-sm';
            if (activeTab === 'inventory') {
                tabInventoryBtn.classList.add('active');
                tabExpenseBtn.classList.remove('active');
                inventoryContent.classList.remove('hidden');
                expenseContent.classList.add('hidden');
            } else {
                tabInventoryBtn.classList.remove('active');
                tabExpenseBtn.classList.add('active');
                inventoryContent.classList.add('hidden');
                expenseContent.classList.remove('hidden');
            }
        }

        tabInventoryBtn.addEventListener('click', () => switchTab('inventory'));
        tabExpenseBtn.addEventListener('click', () => switchTab('expense'));

        // Lógica del formulario de inventario
        const tipoSalidaRadio = document.querySelector('input[name="tipoMovimiento"][value="Salida"]');
        const tipoIngresoRadio = document.querySelector('input[name="tipoMovimiento"][value="Ingreso"]');
        const camposSalidaDiv = document.getElementById('camposSalida');
        const precioVentaInput = document.getElementById('precioVenta');
        const productoSelect = document.getElementById('producto');
        const stockActualSpan = document.getElementById('stockActual');
        const refreshStockBtn = document.getElementById('refreshStockBtn');

        function toggleCamposSalida() {
            if (tipoSalidaRadio.checked) {
                camposSalidaDiv.classList.remove('hidden');
                precioVentaInput.required = true;
            } else {
                camposSalidaDiv.classList.add('hidden');
                precioVentaInput.required = false;
            }
        }

        tipoIngresoRadio.addEventListener('change', toggleCamposSalida);
        tipoSalidaRadio.addEventListener('change', toggleCamposSalida);
        productoSelect.addEventListener('change', (e) => fetchStock(e.target.value));
        refreshStockBtn.addEventListener('click', () => fetchStock(productoSelect.value));

        async function fetchStock(productName) {
            if (!productName) return;
            stockActualSpan.textContent = 'Cargando...';
            try {
                const response = await fetch(`${FULL_SCRIPT_URL}?action=getStock&producto=${encodeURIComponent(productName)}`, { mode: 'cors' });
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                const data = await response.json();
                stockActualSpan.textContent = data.success ? (data.stock ?? 'No encontrado') : 'Error';
            } catch (error) {
                stockActualSpan.textContent = 'Error de red';
                showMessage(`Error al obtener stock: ${error.message}`, 'error');
            }
        }

        // Función genérica para enviar formularios
        async function handleFormSubmit(formElement) {
            loader.style.display = 'block';
            messageDiv.textContent = '';
            messageDiv.className = 'flex-grow p-4 rounded-lg text-center text-sm';
            
            const formData = new FormData(formElement);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(FULL_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    redirect: 'follow',
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    showMessage(result.message || '¡Operación registrada exitosamente!', 'success');
                    formElement.reset();
                    if (formElement.id === 'inventoryForm') {
                        toggleCamposSalida();
                        stockActualSpan.textContent = 'N/A';
                        if (data.producto) fetchStock(data.producto);
                    }
                } else {
                    let errorMessage = result.error || 'Ocurrió un error desconocido.';
                    if (result.error === 'STOCK_INSUFICIENTE') {
                        errorMessage = `Error: Stock insuficiente para '${data.producto}'. Stock actual: ${result.currentStock}.`;
                    }
                    showMessage(errorMessage, 'error');
                }
            } catch (error) {
                showMessage(`Error de conexión: ${error.message}. Verifique su conexión y la configuración del script.`, 'error');
            } finally {
                loader.style.display = 'none';
            }
        }

        inventoryForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleFormSubmit(inventoryForm);
        });

        expenseForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleFormSubmit(expenseForm);
        });

        function showMessage(msg, type) {
            messageDiv.textContent = msg;
            if (type === 'success') messageDiv.className = 'flex-grow p-4 rounded-lg text-center text-sm bg-green-100 text-green-800';
            else if (type === 'error') messageDiv.className = 'flex-grow p-4 rounded-lg text-center text-sm bg-red-100 text-red-800';
            else messageDiv.className = 'flex-grow p-4 rounded-lg text-center text-sm bg-sky-100 text-sky-800';
        }

        // Inicializar
        toggleCamposSalida();
    </script>
</body>
</html>
